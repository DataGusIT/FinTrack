{% extends 'base.html' %}

{% block content %}
<!-- Cabeçalho de Ações -->
<div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-gray-800">Resumo Financeiro</h2>
    <div class="space-x-2">
        <a href="{% url 'expenses:category_list' %}" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-bold hover:bg-gray-200 transition">
            <i class="fas fa-tags mr-2"></i>Categorias
        </a>
        <a href="{% url 'expenses:create' %}" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 transition">
            <i class="fas fa-plus mr-2"></i>Nova Transação
        </a>
    </div>
</div>

<!-- Cards de Resumo Principais -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    
    <!-- Card Saldo Geral -->
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
        <div class="flex items-center justify-between mb-4">
            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Saldo Disponível</span>
            <div class="h-10 w-10 bg-blue-50 rounded-lg flex items-center justify-center text-blue-500">
                <i class="fas fa-wallet text-lg"></i>
            </div>
        </div>
        <div class="flex flex-col">
            <h3 class="text-3xl font-bold text-gray-800 tracking-tight">
                {{ symbol }} {{ balance }}
            </h3>
            <div class="flex items-center mt-2">
                <span class="text-[10px] font-medium {% if balance > 0 %}text-green-500{% else %}text-red-500{% endif %} bg-opacity-10 px-2 py-0.5 rounded">
                    <i class="fas {% if balance > 0 %}fa-circle-check{% else %}fa-circle-exclamation{% endif %} mr-1"></i>
                    Status Financeiro
                </span>
            </div>
        </div>
    </div>

    <!-- Card Receitas -->
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
        <div class="flex items-center justify-between mb-4">
            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Total Recebido</span>
            <div class="h-10 w-10 bg-green-50 rounded-lg flex items-center justify-center text-green-500">
                <i class="fas fa-arrow-trend-up text-lg"></i>
            </div>
        </div>
        <div class="flex flex-col">
            <h3 class="text-3xl font-bold text-green-600 tracking-tight">
                + {{ symbol }} {{ total_income }}
            </h3>
            <p class="text-[10px] text-gray-400 mt-2">Entradas confirmadas no mês</p>
        </div>
    </div>

    <!-- Card Despesas -->
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
        <div class="flex items-center justify-between mb-4">
            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Total Gasto</span>
            <div class="h-10 w-10 bg-red-50 rounded-lg flex items-center justify-center text-red-500">
                <i class="fas fa-arrow-trend-down text-lg"></i>
            </div>
        </div>
        <div class="flex flex-col">
            <h3 class="text-3xl font-bold text-red-600 tracking-tight">
                - {{ symbol }} {{ total_expense }}
            </h3>
            <div class="flex items-center mt-2">
                <!-- Barra de Progresso Corrigida -->
                <div class="w-full bg-gray-100 rounded-full h-1 mr-2">
                    <div class="bg-red-400 h-1 rounded-full" 
                        style="width: {{ display_income_consumed|stringformat:'f'|safe }}%">
                    </div>
                </div>
                <span class="text-[10px] text-gray-400 font-bold whitespace-nowrap">
                    {{ income_consumed_percent|floatformat:0 }}% da renda
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Alerta de Contas Pendentes -->
{% if pending_expenses > 0 %}
<div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-8 flex justify-between items-center rounded-r-lg">
    <div class="flex items-center">
        <i class="fas fa-clock text-yellow-500 mr-3 text-xl"></i>
        <p class="text-sm text-yellow-700">
            Atenção: Você possui <span class="font-bold">R$ {{ pending_expenses }}</span> em contas pendentes para este mês.
        </p>
    </div>
    <span class="text-xs font-bold text-yellow-600 uppercase">Aguardando Pagamento</span>
</div>
{% endif %}

<!-- Seção de Orçamentos -->
<div class="mb-8">
    <h3 class="text-lg font-bold text-gray-800 mb-4">Metas de Gastos</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {% for item in budget_data %}
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <div class="flex justify-between items-center mb-2">
                <span class="font-bold text-gray-700 text-sm">{{ item.category }}</span>
                <span class="text-[10px] {% if item.is_over %}text-red-600 font-bold{% else %}text-gray-400{% endif %}">
                    R$ {{ item.spent|floatformat:2 }} / {{ item.limit|floatformat:0 }}
                </span>
            </div>
            <div class="w-full bg-gray-100 rounded-full h-1.5">
                <div class="h-1.5 rounded-full {% if item.is_over %}bg-red-500{% else %}bg-green-500{% endif %}" 
                    style="width: {{ item.display_percent|stringformat:'f'|safe }}%">
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-span-full bg-blue-50 p-4 rounded-lg text-blue-700 text-sm">
            <i class="fas fa-info-circle mr-2"></i> Nenhuma meta definida. <a href="{% url 'expenses:budget_create' %}" class="underline font-bold">Definir Meta</a>
        </div>
        {% endfor %}
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
    
    <!-- Card Taxa de Poupança -->
    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
        <div class="flex items-center justify-between mb-2">
            <span class="text-[10px] font-bold text-gray-400 uppercase">Taxa de Poupança</span>
            <i class="fas fa-piggy-bank text-blue-400"></i>
        </div>
        <div class="flex items-baseline">
            <h4 class="text-xl font-bold {% if savings_rate > 20 %}text-green-600{% elif savings_rate > 0 %}text-blue-600{% else %}text-red-600{% endif %}">
                {{ savings_rate }}%
            </h4>
        </div>
        <p class="text-[10px] text-gray-400 mt-1">da sua receita foi poupada</p>
    </div>

    <!-- Card Média Diária -->
    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
        <div class="flex items-center justify-between mb-2">
            <span class="text-[10px] font-bold text-gray-400 uppercase">Média Diária</span>
            <i class="fas fa-calendar-day text-purple-400"></i>
        </div>
        <h4 class="text-xl font-bold text-gray-800">R$ {{ daily_avg }}</h4>
        <p class="text-[10px] text-gray-400 mt-1">gastos médios por dia</p>
    </div>

    <!-- Card Projeção -->
    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
        <div class="flex items-center justify-between mb-2">
            <span class="text-[10px] font-bold text-gray-400 uppercase">Projeção Fim do Mês</span>
            <i class="fas fa-chart-line text-orange-400"></i>
        </div>
        <h4 class="text-xl font-bold {% if projection > total_income %}text-red-600{% else %}text-gray-800{% endif %}">
            R$ {{ projection }}
        </h4>
        <p class="text-[10px] text-gray-400 mt-1">estimativa baseada no ritmo atual</p>
    </div>

    <!-- Card Dias Restantes -->
    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
        <div class="flex items-center justify-between mb-2">
            <span class="text-[10px] font-bold text-gray-400 uppercase">Tempo Restante</span>
            <i class="fas fa-hourglass-half text-gray-400"></i>
        </div>
        <h4 class="text-xl font-bold text-gray-800">{{ days_left }} Dias</h4>
        <p class="text-[10px] text-gray-400 mt-1">para encerrar o mês atual</p>
    </div>
</div>

<!-- Área Principal: Extrato e Gráfico -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    
    <div class="lg:col-span-2 bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="p-6 border-b">
            <h3 class="text-lg font-bold text-gray-800">Extrato Recente</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead class="bg-gray-50 text-gray-500 text-[10px] uppercase tracking-wider">
                    <tr>
                        <th class="px-6 py-4 font-bold">Descrição / Método</th>
                        <th class="px-6 py-4 font-bold text-center">Status</th>
                        <th class="px-6 py-4 font-bold">Data</th>
                        <th class="px-6 py-4 font-bold text-right">Valor</th>
                        <th class="px-6 py-4 font-bold text-center">Ações</th>
                    </tr>
                </thead>
                <tbody class="divide-y text-sm">
                    {% for tx in recent_transactions %}
                    <tr class="hover:bg-gray-50 transition {% if tx.status == 'CANCELLED' %}opacity-50{% endif %}">
                        <td class="px-6 py-4">
                            <div class="font-bold {% if tx.status == 'CANCELLED' %}line-through{% endif %}">{{ tx.description }}</div>
                            <div class="text-[10px] text-gray-400 flex items-center mt-1">
                                {% if tx.payment_method == 'CREDIT' or tx.payment_method == 'DEBIT' %}
                                    <i class="fas fa-credit-card mr-1"></i>
                                {% elif tx.payment_method == 'PIX' %}
                                    <i class="fas fa-bolt mr-1"></i>
                                {% elif tx.payment_method == 'CASH' %}
                                    <i class="fas fa-money-bill-wave mr-1"></i>
                                {% else %}
                                    <i class="fas fa-wallet mr-1"></i>
                                {% endif %}
                                {{ tx.get_payment_method_display }}
                                <span class="mx-1">•</span>
                                <span style="color: {{ tx.category.color }}">{{ tx.category.name }}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-center">
                            {% if tx.status == 'PAID' %}
                                <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-[10px] font-bold">PAGO</span>
                            {% elif tx.status == 'PENDING' %}
                                <span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-[10px] font-bold">PENDENTE</span>
                            {% else %}
                                <span class="px-2 py-1 bg-gray-100 text-gray-500 rounded text-[10px] font-bold">CANCELADO</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-gray-500 text-xs">{{ tx.date|date:"d M" }}</td>
                        <td class="px-6 py-4 text-right font-bold {% if tx.type == 'EXPENSE' %}text-red-500{% else %}text-green-500{% endif %}">
                            {% if tx.type == 'EXPENSE' %}-{% else %}+{% endif %} R$ {{ tx.amount }}
                        </td>
                        <td class="px-6 py-4 text-center space-x-2">
                            <a href="{% url 'expenses:update' tx.pk %}" class="text-blue-400 hover:text-blue-600"><i class="fas fa-edit"></i></a>
                            <a href="{% url 'expenses:delete' tx.pk %}" class="text-red-300 hover:text-red-500"><i class="fas fa-trash-alt"></i></a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="px-6 py-10 text-center text-gray-400">Nenhum registro este mês.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Gráfico Lateral -->
    <div class="bg-white p-6 rounded-xl shadow-sm flex flex-col items-center">
        <h3 class="text-lg font-bold text-gray-800 mb-6 self-start">Distribuição</h3>
        {% if category_data %}
            <div class="w-full relative"><canvas id="categoryChart"></canvas></div>
        {% else %}
            <div class="flex flex-col items-center justify-center h-full text-gray-300 py-10">
                <i class="fas fa-chart-pie text-5xl mb-4"></i>
                <p class="text-xs">Sem dados de gastos.</p>
            </div>
        {% endif %}
    </div>
</div>

<div class="mt-8 bg-white p-6 rounded-xl shadow-sm">
    <div class="flex justify-between items-center mb-6">
        <h3 class="text-lg font-bold text-gray-800">Evolução Mensal (Receitas vs Despesas)</h3>
        <span class="text-xs text-gray-400">Últimos 6 meses</span>
    </div>
    <div class="h-64">
        <canvas id="evolutionChart"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('categoryChart');
        if (ctx) {
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: {{ category_labels|safe }},
                    datasets: [{
                        data: {{ category_data|safe }},
                        backgroundColor: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } }
                    },
                    cutout: '75%'
                }
            });
        }
        
        // NOVO: Gráfico de Evolução
        const evoCtx = document.getElementById('evolutionChart');
        if (evoCtx) {
            new Chart(evoCtx, {
                type: 'bar',
                data: {
                    labels: {{ evolution_labels|safe }},
                    datasets: [
                        {
                            label: 'Receitas',
                            data: {{ evolution_income|safe }},
                            backgroundColor: '#10b981', // green-500
                            borderRadius: 4,
                        },
                        {
                            label: 'Despesas',
                            data: {{ evolution_expense|safe }},
                            backgroundColor: '#ef4444', // red-500
                            borderRadius: 4,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { display: false }
                        },
                        x: {
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { position: 'top', align: 'end' }
                    }
                }
            });
        }
    });
</script>
{% endblock %}